---
import Layout from '../../../layouts/Layout.astro';
import BlogListing from '../../../components/BlogListing.astro';
import { getPosts, getAllTags } from '../../../lib/content';

export async function getStaticPaths() {
	const POSTS_PER_PAGE = 6;
	const allPosts = await getPosts();
	const totalPages = Math.max(1, Math.ceil(allPosts.length / POSTS_PER_PAGE));
	
	// Generate paths for pages 2+, page 1 is handled by /blog/index.astro
	const paths = [];
	for (let page = 2; page <= totalPages; page++) {
		paths.push({ params: { page: String(page) } });
	}
	return paths;
}

const POSTS_PER_PAGE = 6;
const currentPage = Number(Astro.params.page);

if (!Number.isFinite(currentPage) || currentPage < 1) {
	return Astro.redirect('/blog');
}

const allPosts = await getPosts();
const tags = await getAllTags();
const totalPages = Math.max(1, Math.ceil(allPosts.length / POSTS_PER_PAGE));

if (currentPage > totalPages) {
	return Astro.redirect('/blog');
}

const start = (currentPage - 1) * POSTS_PER_PAGE;
const posts = allPosts.slice(start, start + POSTS_PER_PAGE);

const pageTitle = `All Stories â€“ Page ${currentPage}`;
const pageDescription = 'Browse every story in the archive.';
---

<Layout title={pageTitle} description={pageDescription}>
	<BlogListing 
		posts={posts} 
		tags={tags} 
		currentPage={currentPage} 
		totalPages={totalPages} 
		totalPosts={allPosts.length}
		basePath="/blog"
	/>
</Layout>
